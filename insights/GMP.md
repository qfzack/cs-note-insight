# GMP

强大的并发能力是Go的特性之一，而这都依赖于Go的并发调度模型GMP

## 关于进程和线程

### 什么是进程和线程

非常常见的一个解释是：

- 进程（Process）是操作系统资源分配的最小单位，一个正在运行的程序就是一个进程
- 线程（Thread）是CPU调度和执行的最小单位，一个进程中可以有多个线程，它们共享进程的资源（内存、文件句柄），但是每个线程有自己的执行栈和寄存器

> CPU执行的最小单位是线程，在单核CPU上，多个线程轮流执行（时间片切换），在多核CPU上，多个线程可以真正并行执行

这个解释看起来很清晰，但是似乎又难以理解，那以实际的程序运行来看进程和线程，当我们通过`go run main.go`启动一个go的程序

- 操作系统会创建一个进程，来为这个程序分配内存空间（代码段、堆、栈等）
- 默认创建主线程来执行main方法
- 如果在这个程序中又创建了其他线程，那么一个进程中就会出现多个线程同时运行

### 线程的理解

大概知道线程是什么以及和进程的关系，但是似乎还是没法理解它到底是一个什么样的存在

在操作系统里，线程的本质是**被内核管理的执行单元**，线程不是代码，而是一组**运行所需的上下文信息**，操作系统用这些信息来调度和执行线程，一个线程通常包括：

- 程序计数器（PC）
  - 指向线程当前正在执行的指令地址
  - 决定CPU下一条要执行的机器指令
- 寄存器集
  - 保存线程运行过程中用到的中间数据
- 栈（Stack）
  - 每个线程有独立的栈空间，用来存放函数调用记录、本地变量、返回地址
- 线程控制块（TCB，Thread Control Block）
  - 操作系统维护的线程信息，记录了线程ID、状态、优先级、寄存器内容、所属进程ID

线程能够执行程序是因为携带了CPU执行所需的上下文，程序计数器告诉CPU下一条要执行的指令，栈保存调用链，寄存器保存中间结果，操作系统为其分配CPU时间片

### 进程的理解

进程与线程的关系可以理解为：**进程提供资源和环境隔离，是一个资源容器，线程负责实际执行任务**，因此进程的主要作用是：

- 资源分配的基本单位
  - 操作系统以进程为单位来分配和管理资源
  - 内存空间、文件句柄、网络端口、环境变量等都是进程级别的
  - 每个进程都有自己独立的虚拟地址空间、不同的进程之间互不干扰
- 保护和隔离
  - 进程保证一个程序出错不会轻易影响到另一个程序
- 作为执行的容器
  - 线程必须寄生在某个进程中，不能独立存在
  - 进程就像一个容器，里面可以运行多个线程

> 进程本身不执行任务，默认会启动一个主线程来让CPU执行指令

## GMP基本概念

GMP是三个对象的缩写：Goroutine、Machine、Processor

- Goroutine就是常用的协程，一般是用`go`关键字加具体的方法来使用，在调度模型里，一个协程可以被看作是一个任务单元，每个协程有自己的执行栈、状态信息等

- Machine可以看作是Go对系统级线程的封装，是真正执行任务（代码）的