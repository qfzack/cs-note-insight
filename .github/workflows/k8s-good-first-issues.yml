name: Monitor K8s Good First Issues

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  check-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Fetch K8s Good First Issues
        id: fetch-issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è®¡ç®—24å°æ—¶å‰çš„æ—¶é—´ï¼ˆ1å¤©ï¼‰
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            console.log(`æŸ¥è¯¢ ${oneDayAgo.toISOString()} ä¹‹åŽåˆ›å»ºçš„ issue`);
            
            // æŸ¥è¯¢ Kubernetes ä»“åº“çš„ good first issue
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: 'kubernetes',
              repo: 'kubernetes',
              labels: 'good first issue',
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 50
            });
            
            // è¿‡æ»¤æœ€è¿‘24å°æ—¶å†…åˆ›å»ºçš„ issue
            const issues = allIssues.filter(issue => {
              const createdAt = new Date(issue.created_at);
              return createdAt >= oneDayAgo;
            });
            
            console.log(`æ‰¾åˆ° ${issues.length} ä¸ªæœ€è¿‘ 1 å¤©å†…åˆ›å»ºçš„é€‚åˆæ–°æ‰‹çš„ issue`);
            
            if (issues.length === 0) {
              console.log('æœ€è¿‘ 1 å¤©å†…æ²¡æœ‰æ–°çš„ good first issue');
              return;
            }
            
            // ç”Ÿæˆ Markdown æŠ¥å‘Š
            let report = `# Kubernetes Good First Issues ç›‘æŽ§æŠ¥å‘Š\n\n`;
            report += `**æ›´æ–°æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;
            report += `**æ—¶é—´èŒƒå›´**: æœ€è¿‘ 1 å¤©ï¼ˆ24å°æ—¶ï¼‰\n\n`;
            report += `**å‘çŽ° ${issues.length} ä¸ªæ–°çš„é€‚åˆæ–°æ‰‹çš„ Issue**\n\n`;
            report += `---\n\n`;
            
            issues.forEach((issue, index) => {
              report += `## ${index + 1}. ${issue.title}\n\n`;
              report += `- **Issue ç¼–å·**: #${issue.number}\n`;
              report += `- **é“¾æŽ¥**: ${issue.html_url}\n`;
              report += `- **åˆ›å»ºæ—¶é—´**: ${new Date(issue.created_at).toLocaleString('zh-CN')}\n`;
              report += `- **æ ‡ç­¾**: ${issue.labels.map(l => l.name).join(', ')}\n`;
              report += `- **è¯„è®ºæ•°**: ${issue.comments}\n\n`;
              
              // æ˜¾ç¤ºéƒ¨åˆ†æè¿°
              if (issue.body) {
                const snippet = issue.body.substring(0, 200).replace(/\n/g, ' ');
                report += `**æè¿°é¢„è§ˆ**: ${snippet}${issue.body.length > 200 ? '...' : ''}\n\n`;
              }
              
              report += `---\n\n`;
            });
            
            // ä¿å­˜æŠ¥å‘Š
            fs.writeFileSync('k8s-issues-report.md', report);
            
            // è¾“å‡ºæ‘˜è¦
            core.summary
              .addHeading('ðŸŽ¯ Kubernetes Good First Issues')
              .addRaw(`å‘çŽ° ${issues.length} ä¸ªé€‚åˆæ–°æ‰‹çš„å¼€æ”¾ Issue`)
              .addTable([
                [{data: 'Issue', header: true}, {data: 'æ ‡é¢˜', header: true}, {data: 'åˆ›å»ºæ—¶é—´', header: true}],
                ...issues.slice(0, 10).map(issue => [
                  `<a href="${issue.html_url}">#${issue.number}</a>`,
                  issue.title,
                  new Date(issue.created_at).toLocaleDateString('zh-CN')
                ])
              ])
              .write();
            
            return issues.length;
      
      - name: Commit and Push Report
        if: steps.fetch-issues.outputs.result > 0
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f "k8s-issues-report.md" ]; then
            git add k8s-issues-report.md
            git diff --staged --quiet || git commit -m "ðŸ¤– æ›´æ–° K8s Good First Issues æŠ¥å‘Š"
            git push
          fi
      
      - name: Create Issue for New Opportunities
        if: steps.fetch-issues.outputs.result > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('k8s-issues-report.md', 'utf8');
            
            // åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„é€šçŸ¥ issue
            const timestamp = new Date().toLocaleString('zh-CN', { 
              timeZone: 'Asia/Shanghai',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            // åˆ›å»ºæ–°çš„é€šçŸ¥ issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“¢ K8s Good First Issues - ${timestamp}`,
              body: report,
              labels: ['k8s-monitoring', 'good-first-issue']
            });
            
            console.log('å·²åˆ›å»ºé€šçŸ¥ issue');
