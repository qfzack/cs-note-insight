name: Monitor Cloud Native Issues

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  check-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Fetch Cloud Native Issues
        id: fetch-issues
        uses: actions/github-script@v7
        env:
          MONITOR_REPOS: ${{ vars.MONITOR_REPOS }}
          MONITOR_LABELS: ${{ vars.MONITOR_LABELS }}
          MONITOR_HOURS: ${{ vars.MONITOR_HOURS || '24' }}
        with:
          script: |
            const fs = require('fs');
            
            const monitorRepos = process.env.MONITOR_REPOS || 'kubernetes/kubernetes';
            const monitorLabels = process.env.MONITOR_LABELS || 'good first issue';
            const monitorHours = parseInt(process.env.MONITOR_HOURS) || 24;
            
            // æ¸…ç†æ ‡ç­¾å­—ç¬¦ä¸²ï¼šç§»é™¤æ‰€æœ‰æ¢è¡Œç¬¦ã€å¤šä½™ç©ºæ ¼
            const cleanedLabels = monitorLabels
              .replace(/\r?\n/g, '')  // ç§»é™¤æ¢è¡Œç¬¦
              .replace(/\s+/g, ' ')   // å¤šä¸ªç©ºæ ¼åˆå¹¶ä¸ºä¸€ä¸ª
              .trim();                // å»é™¤é¦–å°¾ç©ºæ ¼
            
            // å°†æ ‡ç­¾åˆ†å‰²æˆæ•°ç»„
            const labelArray = cleanedLabels.split(',').map(l => l.trim()).filter(l => l.length > 0);
            
            const repoList = monitorRepos
              .replace(/\r?\n/g, '')  // ç§»é™¤æ¢è¡Œç¬¦
              .split(',')
              .map(r => r.trim())
              .filter(r => r.length > 0);
            
            console.log(`ç›‘æ§ä»“åº“ (${repoList.length}ä¸ª):`);
            repoList.forEach(r => console.log(`  - ${r}`));
            console.log(`\nç›‘æ§æ ‡ç­¾ (${labelArray.length}ä¸ª):`);
            labelArray.forEach(l => console.log(`  - ${l}`));
            console.log(`ç›‘æ§æ—¶é—´: ${monitorHours} å°æ—¶`);
            
            const timeAgo = new Date(Date.now() - monitorHours * 60 * 60 * 1000);
            console.log(`æŸ¥è¯¢ ${timeAgo.toISOString()} ä¹‹ååˆ›å»ºçš„ issue\n`);
            
            // å­˜å‚¨æ‰€æœ‰ä»“åº“çš„ issues
            const allRepoIssues = [];
            
            // éå†æ¯ä¸ªä»“åº“
            for (const repoFullName of repoList) {
              const [owner, repo] = repoFullName.split('/');
              console.log(`\næ­£åœ¨æŸ¥è¯¢ ${owner}/${repo}...`);
              
              try {
                // ç”¨ Set å­˜å‚¨ issue ç¼–å·ï¼Œé¿å…é‡å¤
                const issueMap = new Map();
                
                // å¯¹æ¯ä¸ªæ ‡ç­¾åˆ†åˆ«æŸ¥è¯¢ï¼Œå®ç° OR å…³ç³»
                for (const label of labelArray) {
                  console.log(`  æŸ¥è¯¢æ ‡ç­¾ "${label}"...`);
                  const issues = await github.paginate(github.rest.issues.listForRepo, {
                    owner,
                    repo,
                    labels: label,
                    state: 'open',
                    since: timeAgo.toISOString(),
                    sort: 'created',
                    direction: 'desc',
                    per_page: 100
                  });
                  
                  // åˆå¹¶ç»“æœï¼Œå»é‡ï¼Œå¹¶ä¸”ä¸€å¼€å§‹å°±è¿‡æ»¤æ‰ Pull Requests
                  issues.forEach(issue => {
                    if (!issue.pull_request && !issueMap.has(issue.number)) {
                      issueMap.set(issue.number, issue);
                    }
                  });
                }
                
                const allIssues = Array.from(issueMap.values());
                console.log(`  åˆå¹¶å»é‡åå…± ${allIssues.length} ä¸ª issue`);
                
                // å†æ¬¡éªŒè¯æ—¶é—´èŒƒå›´
                const recentIssues = allIssues.filter(issue => {
                  const createdAt = new Date(issue.created_at);
                  return createdAt >= timeAgo;
                });
                
                console.log(`  ç¡®è®¤æœ‰ ${recentIssues.length} ä¸ªæœ€è¿‘ ${monitorHours} å°æ—¶å†…çš„ issue`);
                
                // æ‰“å°æ¯ä¸ªæ‰¾åˆ°çš„ issue çš„è¯¦ç»†ä¿¡æ¯
                if (recentIssues.length > 0) {
                  console.log(`  è¯¦ç»†åˆ—è¡¨:`);
                  recentIssues.forEach((issue, idx) => {
                    console.log(`    ${idx + 1}. #${issue.number} - ${issue.title}`);
                    console.log(`       åˆ›å»ºæ—¶é—´: ${new Date(issue.created_at).toISOString()}`);
                    console.log(`       æ ‡ç­¾: ${issue.labels.map(l => l.name).join(', ')}`);
                    console.log(`       é“¾æ¥: ${issue.html_url}`);
                  });
                  
                  allRepoIssues.push({
                    repo: repoFullName,
                    issues: recentIssues
                  });
                } else {
                  console.log(`  è¯¥ä»“åº“åœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ issue`);
                }
              } catch (error) {
                console.error(`  æŸ¥è¯¢ ${owner}/${repo} å¤±è´¥: ${error.message}`);
              }
            }
            
            const totalIssues = allRepoIssues.reduce((sum, r) => sum + r.issues.length, 0);
            console.log(`\næ€»å…±æ‰¾åˆ° ${totalIssues} ä¸ª issueï¼Œæ¥è‡ª ${allRepoIssues.length} ä¸ªä»“åº“`);
            
            if (totalIssues === 0) {
              console.log(`æœ€è¿‘ ${monitorHours} å°æ—¶å†…æ²¡æœ‰æ–°çš„ issue`);
              return 0;
            }
            
            // ç”Ÿæˆ Markdown æŠ¥å‘Š
            let report = `# Cloud Native Issues ç›‘æ§æŠ¥å‘Š\n\n`;
            report += `**æ›´æ–°æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;
            report += `**ç›‘æ§ä»“åº“**: ${allRepoIssues.length} ä¸ª\n\n`;
            report += `**ç›‘æ§æ ‡ç­¾**: ${labelArray.join(', ')}\n\n`;
            report += `**æ—¶é—´èŒƒå›´**: æœ€è¿‘ ${monitorHours} å°æ—¶\n\n`;
            report += `**å‘ç° ${totalIssues} ä¸ªæ–°çš„ Issue**\n\n`;
            report += `---\n\n`;
            
            // ç”Ÿæˆ HTML é‚®ä»¶æŠ¥å‘Š
            let htmlReport = '<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <style>\n';
            htmlReport += '    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }\n';
            htmlReport += '    .container { background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n';
            htmlReport += '    h1 { color: #0366d6; border-bottom: 3px solid #0366d6; padding-bottom: 10px; margin-top: 0; }\n';
            htmlReport += '    .meta { background: #f6f8fa; padding: 15px; border-radius: 6px; margin: 20px 0; }\n';
            htmlReport += '    .meta-item { margin: 8px 0; }\n';
            htmlReport += '    .meta-label { font-weight: 600; color: #586069; }\n';
            htmlReport += '    .repo-section { margin: 30px 0; border-left: 4px solid #0366d6; padding-left: 20px; }\n';
            htmlReport += '    .repo-title { color: #0366d6; font-size: 1.3em; margin-bottom: 15px; }\n';
            htmlReport += '    .issue-card { background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 6px; padding: 15px; margin: 15px 0; }\n';
            htmlReport += '    .issue-title { font-size: 1.1em; font-weight: 600; color: #24292e; margin-bottom: 10px; }\n';
            htmlReport += '    .issue-meta { font-size: 0.9em; color: #586069; margin: 5px 0; }\n';
            htmlReport += '    .issue-link { color: #0366d6; text-decoration: none; font-weight: 500; }\n';
            htmlReport += '    .issue-link:hover { text-decoration: underline; }\n';
            htmlReport += '    .label { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 0.85em; margin: 2px; background: #dfe2e5; color: #24292e; }\n';
            htmlReport += '    .description { color: #586069; margin-top: 10px; font-size: 0.95em; line-height: 1.5; }\n';
            htmlReport += '    .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e1e4e8; color: #586069; font-size: 0.9em; }\n';
            htmlReport += '  </style>\n</head>\n<body>\n  <div class="container">\n    <h1>ğŸ¯ Cloud Native Issues ç›‘æ§æŠ¥å‘Š</h1>\n    \n    <div class="meta">\n';
            htmlReport += `      <div class="meta-item"><span class="meta-label">æ›´æ–°æ—¶é—´:</span> ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}</div>\n`;
            htmlReport += `      <div class="meta-item"><span class="meta-label">ç›‘æ§ä»“åº“:</span> ${allRepoIssues.length} ä¸ª</div>\n`;
            htmlReport += `      <div class="meta-item"><span class="meta-label">ç›‘æ§æ ‡ç­¾:</span> ${labelArray.join(', ')}</div>\n`;
            htmlReport += `      <div class="meta-item"><span class="meta-label">æ—¶é—´èŒƒå›´:</span> æœ€è¿‘ ${monitorHours} å°æ—¶</div>\n`;
            htmlReport += `      <div class="meta-item"><span class="meta-label">å‘ç° Issue:</span> <strong>${totalIssues} ä¸ª</strong></div>\n`;
            htmlReport += '    </div>\n';
            
            // æŒ‰ä»“åº“åˆ†ç»„æ˜¾ç¤º
            allRepoIssues.forEach(repoData => {
              report += `## ğŸ“¦ ${repoData.repo}\n\n`;
              report += `å‘ç° ${repoData.issues.length} ä¸ªæ–° Issue\n\n`;
              
              htmlReport += '    <div class="repo-section">\n';
              htmlReport += `      <h2 class="repo-title">ğŸ“¦ ${repoData.repo}</h2>\n`;
              
              repoData.issues.forEach((issue, index) => {
                // Markdown ç‰ˆæœ¬
                report += `### ${index + 1}. ${issue.title}\n\n`;
                report += `- **Issue ç¼–å·**: #${issue.number}\n`;
                report += `- **é“¾æ¥**: ${issue.html_url}\n`;
                report += `- **åˆ›å»ºæ—¶é—´**: ${new Date(issue.created_at).toLocaleString('zh-CN')}\n`;
                report += `- **æ ‡ç­¾**: ${issue.labels.map(l => l.name).join(', ')}\n`;
                report += `- **è¯„è®ºæ•°**: ${issue.comments}\n\n`;
                
                // HTML ç‰ˆæœ¬
                htmlReport += '      <div class="issue-card">\n';
                htmlReport += `        <div class="issue-title">${index + 1}. ${issue.title}</div>\n`;
                htmlReport += '        <div class="issue-meta">\n';
                htmlReport += `          <strong>#${issue.number}</strong> | \n`;
                htmlReport += `          <a href="${issue.html_url}" class="issue-link" target="_blank">æŸ¥çœ‹è¯¦æƒ… â†’</a>\n`;
                htmlReport += '        </div>\n';
                htmlReport += '        <div class="issue-meta">\n';
                htmlReport += `          ğŸ“… ${new Date(issue.created_at).toLocaleString('zh-CN')} | \n`;
                htmlReport += `          ğŸ’¬ ${issue.comments} æ¡è¯„è®º\n`;
                htmlReport += '        </div>\n';
                htmlReport += '        <div class="issue-meta">\n';
                htmlReport += `          ${issue.labels.map(l => '<span class="label">' + l.name + '</span>').join(' ')}\n`;
                htmlReport += '        </div>\n';
                
                // æ˜¾ç¤ºéƒ¨åˆ†æè¿°
                if (issue.body) {
                  const snippet = issue.body.substring(0, 200).replace(/\n/g, ' ').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                  report += `**æè¿°é¢„è§ˆ**: ${snippet}${issue.body.length > 200 ? '...' : ''}\n\n`;
                }
                
                report += `---\n\n`;
                htmlReport += '      </div>\n';
              });
              
              report += `\n`;
              htmlReport += '    </div>\n';
            });
            
            htmlReport += '    <div class="footer">\n';
            htmlReport += '      <p>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ</p>\n';
            htmlReport += '    </div>\n';
            htmlReport += '  </div>\n';
            htmlReport += '</body>\n';
            htmlReport += '</html>\n';
            
            // ä¿å­˜æŠ¥å‘Š
            fs.writeFileSync('k8s-issues-report.md', report);
            fs.writeFileSync('k8s-issues-report.html', htmlReport);
            
            // è¾“å‡ºæ‘˜è¦
            core.summary
              .addHeading('ğŸ¯ Cloud Native Issues ç›‘æ§')
              .addRaw(`ç›‘æ§ä»“åº“: ${allRepoIssues.length} ä¸ª`)
              .addRaw(`<br>ç›‘æ§æ ‡ç­¾: ${labelArray.join(', ')}`)
              .addRaw(`<br>å‘ç° ${totalIssues} ä¸ªæ–°çš„å¼€æ”¾ Issue`);
            
            // ä¸ºæ¯ä¸ªä»“åº“æ·»åŠ è¡¨æ ¼
            allRepoIssues.forEach(repoData => {
              if (repoData.issues.length > 0) {
                core.summary
                  .addHeading(`ğŸ“¦ ${repoData.repo}`, 3)
                  .addTable([
                    [{data: 'Issue', header: true}, {data: 'æ ‡é¢˜', header: true}, {data: 'åˆ›å»ºæ—¶é—´', header: true}],
                    ...repoData.issues.slice(0, 5).map(issue => [
                      `<a href="${issue.html_url}">#${issue.number}</a>`,
                      issue.title,
                      new Date(issue.created_at).toLocaleDateString('zh-CN')
                    ])
                  ]);
              }
            });
            
            core.summary.write();
            
            return totalIssues;
      
      - name: Send Email Notification
        if: steps.fetch-issues.outputs.result > 0
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ vars.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ğŸ¯ Cloud Native Issues ç›‘æ§æŠ¥å‘Š
          to: ${{ vars.EMAIL_TO }}
          from: ${{ vars.EMAIL_USERNAME }}
          html_body: file://k8s-issues-report.html
      
      - name: Cleanup
        if: always()
        run: |
          rm -f k8s-issues-report.md k8s-issues-report.html
          echo "æ¸…ç†å®Œæˆ"
